# Протокол обмена данными c видео-сервером Av-03

## История версий

Версия 0.1 от 29.10.22.

## Общие принципы информационного обмена

Предлагаемый вариант информационного обмена между системами проводится
по единой технологии «клиент-сервер» в одноранговой сети Ethernet на
базе протокола TCP.
При обмене и клиент и сервер используют прямое соединение и фиксированные IP адреса.
Порт сервера номер в конфиг файле.

## Организация взаимодействия «клиент-сервер»

Соединение и обмен данными организуется по инициативе клиента, который
после установки соединения посылает серверу в произвольной
последовательности запросы вида:

Поле | Тип | Описание
---|---|---
`Length` | `uint32` | Длина передаваемого пакета в байтах (положительное число)
`Comand` | `uint32` | Команда (символьная строка, обозначающая посылаемый запрос). [Перечень команд](#перечень-команд-обрабатываемых-сервером), обрабатываемых сервером.
`Data`  | |   Данные, необходимые для выполнения команды

При получении запроса сервер проверяет корректность команды и отправляет клиенту ответ вида:

Поле | Тип | Описание
---|---|---
`Length` | `int32` | Длина передаваемого пакета в байтах; или, если число отрицательное - код ошибки
`Data` | |  Данные, отправляемые в ответ на команду (если `Length` не отрицательно число)

В случае успешного выполнения команды сервером не требующего передачи дополнительных данных (см. состав и структура поля Data для каждой из команд) возвращается структура [OK_RESPONSE](#ok_response), в котором поле `Data` нулевой длины.

В случае получения некорректного запроса сервер в ответ на запрос отправляет пакет длиной 4 байта,
содержащий [код ошибки](#перечень-кодов-ошибок-формируемых-сервером)
(отрицательное число типа `int32`).

## Перечень команд, обрабатываемых сервером

Ниже приведен список всех команд, обрабатываемых сервером:

Команда | Описание
---|---
|| **Работа со сессиями**
[SLST](#SLST) | Запрос списка доступных идентификаторов сессий для ранее выбранного измерительного средства
[SSET](#sset) | Установить текущий идентификатор измерительной сессии
_ | **Работа с диапазонами данных**
[SGET](#SGET) | Получить текущий идентификатор измерительной сессии
[SBEG](#SBEG) | Получить первый (начальный) [индекс](#sindex) для текущей измерительной сессии
[SEND](#SEND) | Получить последний (конечный) [индекс](#sindex) для текущей измерительной сессии
|| **Работа с описанием видео каналов**
[NVID](#nvid) | Получить количество каналов видеоданных
[GVID](#GVID) | Получить конфигурацию канала видеоданных для текущей измерительной сессии
|| **Работа с видео данными**
[FMRK](#FMRK) | Получить идентификатор [индекс](#sindex) кадра, на который приходится запрашиваемый  индекс.
[GFRM](#GFRM) | Получить кадр данных и его индекс, на который приходится запрашиваемый [индекс](#sindex)
[NFRM](#NFRM) | Получить следующий кадр и его индекс, относительно того, на который приходится запрашиваемый [индекс](#sindex) кадра
[PFRM](#PFRM) | Получить предыдущий кадр и его индекс, относительно того, на который приходится запрашиваемый [индекс](#sindex) кадра
|| **Работа с ошибками**
[GLEM](#GLEM) | Получить строковое описание последней возникшей ошибки
|| **Работа с данными путейской координаты**
[GCRD](#GCRD) | Получить информацию о километровой привязке

### Подробное описание команд

#### Работа со сессиями

##### SLST

Запрос списка доступных идентификаторов сессий.

**Запрос:**
Два поля `u32` описывающие начало и конец диапазона (unix time) поиска сессии.

**Ответ:**
Поле содержит список идентификаторов измерительных сессий
для текущего измерительного средства.
Каждый ID записан в виде завершающейся нулем строки.

##### SSET

Установить текущий идентификатор измерительной сессии,
для которого в дальнейшем возможен запрос данных.

**Запрос:**
Поле содержит идентификатор измерительной сессии,
записанный в виде завершающейся нулем строки.

**Ответ:**
Если команда выполнена успешно - [OK_RESPONSE](#ok_response)

#### Работа с диапазонами данных

##### SGET

Получить текущий идентификатор измерительной сессии.
Предварительно должна быть вызвана команда [SSET](#sset).

**Запрос:**
Поле не используется

**Ответ:**
Поле содержит идентификатор измерительной сессии,
записанный в виде завершающейся нулем строки.

**Ошибки:**
Если сессия ранее не была установлен командой [SSET](#sset) – [SSET_REQUIRED].

##### SBEG

Получить первый (начальный) идентификатор кадра [индекс](#sindex)
для текущей измерительной сессии.
Предварительно должна быть вызвана команда [SSET](#sset).

**Запрос:**
Поле не используется.

**Ответ:**
Поле содержит структуру [SIndex].

##### SEND

Получить последний (конечный) идентификатор кадра [индекс](#sindex)
для текущей измерительной сессии.
Предварительно должна быть вызвана команда [SSET](#sset).

**Запрос:**
Поле не используется

**Ответ:**
Поле содержит структуру [SIndex]

#### Работа с описанием видео каналов

##### NVID

Получить количество каналов видеоданных.
Предварительно должна быть вызвана команда [SSET](#sset).

**Запрос:**
Поле не используется.

**Ответ:**
Поле содержит структуру [NChannel](#nchannel),
содержащее в поле num общее количество каналов данных.

##### GVID

Получить конфигурацию канала видеоданных для текущей измерительной сессии.
Предварительно должна быть вызвана команда [SSET](#sset).

**Запрос:**
Поле содержит структуру [NChannel](#nchannel), содержащее в поле num индекс канала видеоданных.
Поле может принимать значения от 0 до [NChannel](#nchannel).num-1,
полученное в ответ на команду [NVID](#nvid)

**Ответ:**
Ответ содержит xml с завершающим 0 с описанием видеоканала.

#### Работа с видео данными

##### FMRK

Получить  идентификатор [индекс](#sindex)  кадра,
на который приходится запрашиваемый составной индекс.
Предварительно должны быть вызваны команды [VSET](#vset).
Последовательно вызывает [SFND](#sfnd), [SSET](#sset).

**Запрос:**
Поле содержит структуру [SChannelIndex]

**Ответ:**
Поле содержит структуру [SIndex].

**Ошибки:**
Если идентификатор ранее не был установлен командой [VSET](#vset) – [VSET_REQUIRED].

##### GFRM

Получить кадр данных, на который приходится запрашиваемый составной индекс.
Дополнительно возвращается идентификатор [индекс](#sindex) кадра.
Предварительно должны быть вызваны команды [VSET](#vset).
Последовательно вызывает [SFND](#sfnd), [SSET](#sset).

**Запрос:**
Поле содержит структуру [SChannelIndex]

**Ответ:**
Поле содержит структуру [SIndexFrame].

**Ошибки:**
Если идентификатор ранее не был установлен командой [VSET](#vset) – [VSET_REQUIRED].

##### NFRM

Получить следующий, относительно того, на который приходится запрашиваемый
составной индекс, кадр данных.
Дополнительно возвращается идентификатор [индекс](#sindex) кадра.
Предварительно должна быть вызвана команда [SSET](#sset).

**Запрос:**
Поле содержит структуру [SChannelIndex]

**Ответ:**
Поле содержит структуру [SIndexFrame].

##### PFRM

Получить предыдущий, относительно того, на который приходится запрашиваемый
составной индекс, кадр данных.
Дополнительно возвращается идентификатор [индекс](#sindex)  кадра.
Предварительно должна быть вызвана команда [SSET](#sset).

**Запрос:**
Поле содержит структуру [SChannelIndex]

**Ответ:**
Поле содержит структуру [SIndexFrame].

#### Работа с ошибками

##### GLEM

Получить строковое описание последней возникшей ошибки.

**Запрос:**
Поле не используется.

**Ответ:**
Поле содержит завершающуюся нулем строку с описанием последней возникшей ошибки.

#### Работа с данными путейской координаты

##### GCRD

Получить информацию о километровой привязке.
Предварительно должна быть вызвана команда [SSET](#sset).

**Запрос:**
Поле содержит структуру [SIndex]

**Ответ:**
Поле содержит структуру [SCoord].

### Формат данных запроса и ответа

#### OK_RESPONSE

В случае успешного выполнения команды сервером не требующего передачи дополнительных данных
(см. состав и структура поля `Data` для каждой из команд)
возвращается структура [OK_RESPONSE](#ok_response), в котором поле Data нулевой длины.

#### Используемые структуры данных

Примечание:

* Все строковые параметры записаны в кодировке `UTF-8`.
* Порядок записи данных: `little-endian`.
* Выравнивание данных в структурах не используется (равно 1).

##### NChannel

``` c++
    struct NChannel
    {
        uint8 num;           ///< количество или индекс канала данных
    };
```

##### SIndex

Индекс

``` c++

    struct SIndex
    {
        int32  value;       ///<  индекс
    };
```

##### SChannelIndex

``` c++
    struct SChannelIndex:
        NChannel,
        SIndex
    {
    };
```

##### SFrame

Данные видео кадра

``` c++
    struct SFrame
    {
        uint32 size;            ///< размер кадра данных (байты)
        uint8  frame[];        ///< кадр данных JPEG-фрейм
    };
```

##### SIndexFrame

составной индекс и данные кадра

``` c++
    struct SIndexFrame:
        SIndex,
        SFrame
    {
    };
```

##### SCoord

Данные путейской координаты

``` c++
    struct SCoord
    {
        int32  track_id;     ///< идентификатор трека
        double track_offset; ///< смещение относительно начала трека
        uint32 line;         ///< код направления
        uint8  park;         ///< код парка (0 – если путь не парковый)
        uint8  way[20];      ///< номер пути (UTF-8 строка)
        int16  km;           ///< номер километра
        double m;            ///< метр
        double lat           ///< широта
        double lon;          ///< долгота
        double dc;           ///< относительная координата в метрах от начала сессии
    };
```

#### Перечень кодов ошибок, формируемых сервером

Сообщения об ошибке, формируемые сервером представляют собой 4-х байтные слова (int32), содержащие отрицательный код ошибки.

Значение | Код | Наименование | Описание
---|---|---|---
-1 | `UNKNOWN_COMMAND`  | Неизвестная команда  | В запросе передан неизвестный серверу код команды
-5 | `SSET_REQUIRED` | Не был установлен текущий ID измерительной сессии  | Выполнена команда, для которой ранее должна была быть  выполнена [SSET](#sset)
-6 | `DATA_NOT_FOUND` | Данные не найдены  | Данные для ответа не  найдены
-7 | `WRONG_REQUEST` | Неверный запрос данных   | Переданы данные, которые не могут быть использованы в данном запросе или неверная структура сообщения запроса
-10 | `INTERNAL` | Внутренняя ошибка сервера | Произошла внутренняя ошибка сервера

[SSET_REQUIRED]: #перечень-кодов-ошибок-формируемых-сервером

## Пример использования

Пример с использованием [SSET](#sset)

1. Вызвать [SLST](#slst), для поучения списка сессиий.
2. Вызвать [SSET](#sset) для выбра рабочей сессию, из списка полученную на предыдущем шаге.
3. Вызвать [NVID](#nvid)/[GVID](#gvid) для получения конфигурации каналов видеоданных.
4. При необходимости вызвать [SBEG](#sbeg), [SEND](#send) для определения граничных составных индексов.
5. Вызвать [GFRM](#gfrm), для указанного составного индекса кадра и канала видеоданных получить JPEG-фрейм.
6. При необходимости последовательно вызывать [NFRM](#nfrm) или [PFRM](#pfrm) для получения следующего/предыдущего JPEG-фрейма.
