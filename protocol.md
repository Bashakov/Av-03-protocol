
# История версий

Версия 0.5 от 23.08.23

- добавлена команда [GSDC](#gsdc) запрос параметров сессии,
- добавлена команда [GVEL](#gvel) запрос скорости,
- добавлена команда [GUTM](#gvel) запрос времени UNIX
- расширена структура [SGlobalPos](#sglobalpos), добавлена высота

Версия 0.4 от 31.07.23

- увеличена длинна полей `up_code` и `way_code` в структуре [SCoord](#scoord)

Версия 0.3 от 04.07.23

- отредактирована структура [SCoord](#scoord)
- удалена структура `STemperatureResult`
- удалена структура `STemperatureIndex`
- удалена команда `TGTR`
- добавлена команда [GGPS](#ggps)
- добавлена структура [SGlobalPos](#sglobalpos)

Версия 0.2 от 29.12.22.

- Исправлено описание команд получения видео.
- Добавлены номера каналов в функции получения видео, там где отсутствовали.
- Добавлена команда получения данных температуры.
- Исправлены ссылки.
- Изменена организация разделов (уменьшена глубина).

Версия 0.1 от 29.10.22.

- Начало работы.

# Общие принципы информационного обмена

Предлагаемый вариант информационного обмена между системами проводится
по единой технологии «клиент-сервер» в одноранговой сети Ethernet на
базе протокола TCP.
При обмене и клиент и сервер используют прямое соединение и фиксированные IP адреса.
Порт сервера номер в конфиг файле.

## Организация взаимодействия «клиент-сервер»

Соединение и обмен данными организуется по инициативе клиента, который
после установки соединения посылает серверу в произвольной
последовательности запросы вида:

Поле | Тип | Описание
---|---|---
`Length` | `uint32` | Длина передаваемого пакета в байтах (положительное число)
`Command` | `uint32` | Команда (символьная строка, обозначающая посылаемый запрос). [Перечень команд](#перечень-команд-обрабатываемых-сервером), обрабатываемых сервером.
`Data`  | |   Данные, необходимые для выполнения команды

При получении запроса сервер проверяет корректность команды и отправляет клиенту ответ вида:

Поле | Тип | Описание
---|---|---
`Length` | `int32` | Длина передаваемого пакета в байтах; или, если число отрицательное: код ошибки
`Data` | |  Данные, отправляемые в ответ на команду (если `Length` не отрицательно число)

В случае успешного выполнения команды сервером не требующего передачи дополнительных данных (см. состав и структура поля Data для каждой из команд) возвращается структура [OK_RESPONSE](#ok_response), в котором поле `Data` нулевой длины.

В случае получения некорректного запроса сервер в ответ на запрос отправляет пакет длиной 4 байта,
содержащий [код ошибки](#перечень-кодов-ошибок-формируемых-сервером)
(отрицательное число типа `int32`).

## Перечень команд, обрабатываемых сервером

Ниже приведен список всех команд, обрабатываемых сервером:

Команда | Описание
---|---
|| **Работа со сессиями**
[SLST](#slst) | Запрос списка доступных идентификаторов сессий для ранее выбранного измерительного средства
[SSET](#sset) | Установить текущий идентификатор измерительной сессии
[SGET](#sget) | Получить текущий идентификатор измерительной сессии
_ | **Получение общих данных о сессии**
[GSDC](#gsdc) | Получить описание сессии
[SBEG](#sbeg) | Получить первый (начальный) [индекс](#sindex) для текущей измерительной сессии
[SEND](#send) | Получить последний (конечный) [индекс](#sindex) для текущей измерительной сессии
|| **Работа с описанием видео каналов**
[NVID](#nvid) | Получить количество каналов видеоданных
[GVID](#gvid) | Получить конфигурацию канала видеоданных для текущей измерительной сессии
|| **Работа с видео данными**
[FMRK](#fmrk) | Получить идентификатор [индекс](#sindex) кадра, на который приходится запрашиваемый  индекс.
[GFRM](#gfrm) | Получить кадр данных и его индекс, на который приходится запрашиваемый [индекс](#sindex)
[NFRM](#nfrm) | Получить следующий кадр и его индекс, относительно того, на который приходится запрашиваемый [индекс](#sindex) кадра
[PFRM](#pfrm) | Получить предыдущий кадр и его индекс, относительно того, на который приходится запрашиваемый [индекс](#sindex) кадра
|| **Работа с данными путейской координаты**
[GCRD](#gcrd) | Получить информацию о километровой привязке
|| **Работа с данными глобальной координаты**
[GGPS](#ggps) | Получить информацию о глобальной координате
|| **Работа с дополнительными данными**
[TGTI](#tgti) | Получить интерполированные данные о температуре
[GVEL](#gvel) | Получить интерполированные значение скорости
[GUTM](#gutm) | Получить интерполированные временя UNIX
|| **Работа с ошибками**
[GLEM](#glem) | Получить строковое описание последней возникшей ошибки

### Работа с сессиями

#### SLST

Запрос списка доступных идентификаторов сессий.

**Запрос:**
Два поля `u32` описывающие начало и конец диапазона (unix time) поиска сессии.

**Ответ:**
Поле содержит список идентификаторов измерительных сессий
для текущего измерительного средства.
Каждый ID записан в виде завершающейся нулем строки.

#### SSET

Установить текущий идентификатор измерительной сессии,
для которого в дальнейшем возможен запрос данных.

**Запрос:**
Поле содержит идентификатор измерительной сессии,
записанный в виде завершающейся нулем строки.

**Ответ:**
Если команда выполнена успешно - [OK_RESPONSE](#ok_response)

### Работа с диапазонами данных

#### SGET

Получить текущий идентификатор измерительной сессии.
Предварительно должна быть вызвана команда [SSET](#sset).

**Запрос:**
Поле не используется

**Ответ:**
Поле содержит идентификатор измерительной сессии,
записанный в виде завершающейся нулем строки.

#### GSDC

Получить описание сессии.
Предварительно должна быть вызвана команда [SSET](#sset).

**Запрос:**
Поле не используется.

**Ответ:**
Строка с XML, содержащая описание сессии. Пример:

```xml
<REGISTRATION_DATA SOURCE="[498]_2021_09_17_36" NAME="[498]_2021_09_17_36" GUID="{9ACDAA9C-440B-4FCF-8B02-B147030BD269}">
    <DATA INNER="DATE" NAME="Дата регистрации" VALUE="2021:09:17:13:24"/>
    <DATA INNER="STOP_DATE" NAME="Дата окончания регистрации" VALUE="2021:09:17:17:35"/>
    <DATA INNER="FIRST_LEFT" NAME="Первый рельс - левый" VALUE="0"/>
    <DATA INNER="INCREASE" NAME="Регистрация по ходу километров" VALUE="1"/>
    <DATA INNER="ORIENTATION" NAME="Котлом вперёд" VALUE="1"/>
    <DATA INNER="START_PK" NAME="Стартовый пикет" VALUE="1"/>
    <DATA INNER="START_KM" NAME="Стартовый км" VALUE="239"/>
    <DATA INNER="START_CHOORD" NAME="Начало регистрации" VALUE="0239:100"/>
    <DATA INNER="END_CHOORD" NAME="Конец регистрации" VALUE="0295:275"/>
    <DATA INNER="TRACK_NUM" NAME="Путь" VALUE="1"/>
    <DATA INNER="TRACK_CODE" NAME="Код пути" VALUE="110000123168"/>
    <DATA INNER="DIR_CODE" NAME="Код направления" VALUE="15802"/>
    <DATA INNER="PICKET_BEAT" NAME="Отбой пикетов" VALUE="0"/>
    <DATA INNER="DIRECTION" NAME="Направление" VALUE="Рыбинск-Псков (15802)"/>
    <DATA INNER="IPS_CONST_REG_MODIF" NAME="Модификация константы колеса при регистрации" VALUE="0"/>
    <DATA INNER="IPS_CONST_FLAG" NAME="Наличие записи константы колеса для данного проезда в XML-паспорте" VALUE="1"/>
    <DATA INNER="IPS_CONST" NAME="Значение константы колеса, с которой был записан проезд" VALUE="2412509"/>
    <DATA INNER="SUPPORTS_VIDEO" NAME="Для проезда производилась запись видео данных" VALUE="1"/>
    <DATA INNER="SUPPORTS_TEMP" NAME="Проезд содержит данные температуры" VALUE="1"/>
    <DATA INNER="SUPPORTS_GPS" NAME="Проезд содержит данные GPS" VALUE="1"/>
    <DATA INNER="SUPPORTS_SLUMPS" NAME="Проезд содержит данные просадок" VALUE="0"/>
    <DATA INNER="MIS_CONTROLLED_INTERVAL_AUTO_CHECK" NAME="Автоматическая проверка на непроконтролированные участки" VALUE="0"/>
    <DATA INNER="OPERATOR" NAME="Оператор" VALUE=""/>
    <DATA INNER="SEQUENCE_NUMBER" NAME="Номер проезда" VALUE=""/>
</REGISTRATION_DATA>
```

#### SBEG

Получить первый (начальный) [индекс](#sindex) для текущей измерительной сессии.
Предварительно должна быть вызвана команда [SSET](#sset).

**Запрос:**
Поле не используется.

**Ответ:**
Поле содержит структуру [SIndex](#sindex).

#### SEND

Получить последний (конечный) [индекс](#sindex) для текущей измерительной сессии.
Предварительно должна быть вызвана команда [SSET](#sset).

**Запрос:**
Поле не используется

**Ответ:**
Поле содержит структуру [SIndex](#sindex)

### Работа с описанием видео каналов

#### NVID

Получить количество каналов видеоданных.
Предварительно должна быть вызвана команда [SSET](#sset).

**Запрос:**
Поле не используется.

**Ответ:**
Поле содержит структуру [NChannel](#nchannel),
содержащее в поле num общее количество каналов данных.

#### GVID

Получить конфигурацию канала видеоданных для текущей измерительной сессии.
Предварительно должна быть вызвана команда [SSET](#sset).

**Запрос:**
Поле содержит структуру [NChannel](#nchannel), содержащее в поле `num` индекс канала видеоданных.
Поле может принимать значения от `0` до `NChannel.num-1`,
полученное в ответ на команду [NVID](#nvid)

**Ответ:**
Ответ содержит xml с завершающим 0 с описанием видеоканала.
Пример:

```xml
<FRAME>
    <PARAM name="VisibleWidthMm" value="1024"/>
    <PARAM name="DependOnOrientation" value="0"/>
    <PARAM name="CameraPosition" value="CorrIn"/>
    <PARAM name="VerticalMirrorOnEncode" value="0"/>
    <PARAM name="width" value="1024"/>
    <PARAM name="height" value="504"/>
    <PARAM name="interlaced" value="0"/>
    <PARAM name="grayscale" value="1"/>
    <PARAM name="reflect" value="0"/>
    <PARAM name="HalfOriginalFrameHeight" value="0"/>
    <PARAM name="PreparedForPanoramicView" value="1"/>
    <PARAM name="Gray16EncodeQuality" value="75"/>
    <PARAM name="Gray16RShiftBit" value="2"/>
</FRAME>
```

### Работа с видео данными

#### FMRK

Получить  идентификатор [SChannelIndex](#schannelindex) кадра,
на который приходится запрашиваемый индекс.

Предварительно должны быть вызвана команда [SSET](#sset).

**Запрос:**
Поле содержит структуру [SChannelIndex](#schannelindex)

**Ответ:**
Поле содержит структуру [SChannelIndex](#schannelindex).

**Ошибки:**

- [SSET_REQUIRED] сессия ранее не была установлена командой [SSET](#sset).
- [DATA_NOT_FOUND] не найдены данные на запрошенный индекс.
  
#### GFRM

Получить данные кадра, по индексу кадра [SChannelIndex](#schannelindex).

Предварительно должны быть вызвана команда [SSET](#sset).

**Запрос:**
Поле содержит структуру [SChannelIndex](#schannelindex)

**Ответ:**
Поле содержит структуру [SIndexFrame](#sindexframe).

**Ошибки:**

- [SSET_REQUIRED] сессия ранее не была установлена командой [SSET](#sset).
- [DATA_NOT_FOUND] не найдены данные на запрошенный индекс,
    запрашиваемый индекс должен быть возвращен одной из функций
    [FMRK](#fmrk), [NFRM](#nfrm), [PFRM](#pfrm).

#### NFRM

Получить следующий, относительно того, на который приходится запрашиваемый индекс, кадр данных.
Дополнительно возвращается идентификатор [SChannelIndex](#schannelindex) кадра.

Предварительно должна быть вызвана команда [SSET](#sset).

**Запрос:**
Поле содержит структуру [SChannelIndex](#schannelindex)

**Ответ:**
Поле содержит структуру [SIndexFrame](#sindexframe).

**Ошибки:**

- [SSET_REQUIRED] сессия ранее не была установлена командой [SSET](#sset).
- [DATA_NOT_FOUND] данные следующие за запрошенным индексом не существуют или еще не записаны.

#### PFRM

Получить предыдущий, относительно того, на который приходится запрашиваемый индекс, кадр данных.
Дополнительно возвращается идентификатор [SChannelIndex](#schannelindex) кадра.

Предварительно должна быть вызвана команда [SSET](#sset).

**Запрос:**
Поле содержит структуру [SChannelIndex](#schannelindex)

**Ответ:**
Поле содержит структуру [SIndexFrame](#sindexframe).

**Ошибки:**

- [SSET_REQUIRED] сессия ранее не была установлена командой [SSET](#sset).
- [DATA_NOT_FOUND] данные перед запрошенным индексом не существуют.

### Работа с дополнительными данными

#### TGTI

Получить интерполированные данные температуры на [индекс](#sindex) .

Предварительно должна быть вызвана команда [SSET](#sset).

**Запрос:**

Поле содержит [SIndex](#sindex).

**Ответ:**

Поле содержит  температуру [STemperature](#stemperature).

#### GVEL

Получить интерполированные значение скорости на [индекс](#sindex).

Предварительно должна быть вызвана команда [SSET](#sset).

**Запрос:**

[SIndex](#sindex).

**Ответ:**

8 байт `double`.

#### GUTM

Получить интерполированное значение UNIX time на [индекс](#sindex) .

Предварительно должна быть вызвана команда [SSET](#sset).

**Запрос:**

[SIndex](#sindex).

**Ответ:**

4 байта беззнаковое целое.

### Работа с данными путейской координаты

#### GCRD

Получить информацию о километровой привязке.
Предварительно должна быть вызвана команда [SSET](#sset).

**Запрос:**
Поле содержит структуру [SIndex](#sindex).

**Ответ:**
Поле содержит структуру [SCoord](#scoord).

### Работа с данными глобальной координаты

#### GGPS

Получить информацию о глобальной координате
Предварительно должна быть вызвана команда [SSET](#sset).

**Запрос:**
Поле содержит структуру [SIndex](#sindex).

**Ответ:**
Поле содержит структуру [SGlobalPos](#sglobalpos).

### Работа с ошибками

#### GLEM

Получить строковое описание последней возникшей ошибки.

**Запрос:**
Поле не используется.

**Ответ:**
Поле содержит завершающуюся нулем строку с описанием последней возникшей ошибки.

## Формат данных запроса и ответа

Примечание:

- Все строковые параметры записаны в кодировке `UTF-8`.
- Порядок записи данных: `little-endian`.
- Выравнивание данных в структурах не используется (равно 1).

### OK_RESPONSE

В случае успешного выполнения команды сервером не требующего передачи дополнительных данных
(см. состав и структура поля `Data` для каждой из команд)
возвращается структура [OK_RESPONSE](#ok_response), в котором поле Data нулевой длины.

### NChannel

Работа с номерами видео каналов.

``` c++
    struct NChannel
    {
        uint8 num;           ///< количество или индекс канала данных
    };
```

### SIndex

Индекс, по которому производится синхронизация между различными компонентами системы.

Непрерывно растет в течении сессии, состояние между сессиями не определено.

``` c++
    struct SIndex
    {
        int32  value;       ///<  индекс
    };
```

### SChannelIndex

Индекс видео кадра: номер канала + индекс координаты.

``` c++
    struct SChannelIndex
        : NChannel
        , SIndex
    {
    };
```

### SFrame

Данные видео кадра

``` c++
    struct SFrame
    {
        uint32 size;           ///< размер кадра данных (байты)
        uint8  frame[];        ///< кадр данных JPEG-фрейм
    };
```

### SIndexFrame

индекс кадра и данные кадра

``` c++
    struct SIndexFrame:
        SChannelIndex,
        SFrame
    {
    };
```

### SCoord

Данные путейской координаты

``` c++
    struct SCoord
    {
        int32  site_id;      ///< код дороги
        uint8  up_code[64];  ///< код направления (UTF-8 строка)
        uint8  way_code[64]; ///< код пути (UTF-8 строка)
        int32  km;           ///< номер километра
        int32  m;            ///< миллиметр
        int32  dc;           ///< относительная координата (миллиметр) от начала сессии
    };
```

### SIndexFilter

Пара значений индекса, для выбора диапазона данных

``` c++
    struct SIndexFilter
    {
        SIndex  from;       ///< начало диапазона (0 - начало сессии)
        SIndex  to;         ///< конец диапазона (-1 - конец сессии)
    };
```

### STemperature

Данные температуры.

``` c++
    struct STemperature
    {
        float   left_rail;
        float   right_rail;
        float   left_air;
        float   right_air;
    };
```

### SGlobalPos

Данные о глобальном положении.

``` c++
    struct SIndexFilter
    {
        double latitude;    ///< широта
        double longitude;   ///< долгота
        double altitude;    ///< высота в метрах
    };
```

## Перечень кодов ошибок, формируемых сервером

Сообщения об ошибке, формируемые сервером представляют собой 4-х байтные слова (int32), содержащие отрицательный код ошибки.

Значение | Код | Наименование | Описание
---|---|---|---
-1 | `UNKNOWN_COMMAND`  | Неизвестная команда  | В запросе передан неизвестный серверу код команды
-5 | `SSET_REQUIRED` | Сессия не выбрана  | Выполнена команда, для которой ранее должна была быть  выполнена [SSET](#sset)
-6 | `DATA_NOT_FOUND` | Данные не найдены | Данные для ответа не найдены
-7 | `WRONG_REQUEST` | Неверный запрос данных | Переданы данные, которые не могут быть использованы в данном запросе или неверная структура сообщения запроса
-10 | `INTERNAL` | Внутренняя ошибка сервера | Произошла внутренняя ошибка сервера

[SSET_REQUIRED]: #перечень-кодов-ошибок-формируемых-сервером
[DATA_NOT_FOUND]: #перечень-кодов-ошибок-формируемых-сервером

# Пример использования

Пример с использованием [SSET](#sset)

1. Вызвать [SLST](#slst), для поучения списка сессий.
2. Вызвать [SSET](#sset) для выбора рабочей сессию, из списка полученную на предыдущем шаге.
3. Вызвать [NVID](#nvid)/[GVID](#gvid) для получения конфигурации каналов видеоданных.
4. При необходимости вызвать [SBEG](#sbeg), [SEND](#send) для определения граничных составных индексов.
5. Вызвать [FMRK](#fmrk) и [GFRM](#gfrm), для указанного составного индекса кадра и канала видеоданных получить JPEG-фрейм.
6. При необходимости последовательно вызывать [NFRM](#nfrm) или [PFRM](#pfrm) для получения следующего/предыдущего JPEG-фрейма.
