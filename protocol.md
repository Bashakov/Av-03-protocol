# Протокол обмена данными c видео-сервером Av-03

## История версий

Версия 0.0 от 23.07.2021.

## Общие принципы информационного обмена

Предлагаемый вариант информационного обмена между системами проводится
по единой технологии «клиент-сервер» в одноранговой сети Ethernet на
базе протокола TCP.
При обмене и клиент и сервер используют прямое соединение и фиксированные IP адреса.
Порт сервера номер в конфиг файле.

## Организация взаимодействия «клиент-сервер»

Соединение и обмен данными организуется по инициативе клиента, который
после установки соединения посылает серверу в произвольной
последовательности запросы вида:

Поле | Тип | Описание
---|---|---
`Length` | `uint32` | Длина передаваемого пакета в байтах (положительное число)
`Comand` | `uint32` | Команда (символьная строка, обозначающая посылаемый запрос). [Перечень команд](#перечень-команд-обрабатываемых-сервером), обрабатываемых сервером.
`Data`  | |   Данные, необходимые для выполнения команды

При получении запроса сервер проверяет корректность команды и отправляет клиенту ответ вида:

Поле | Тип | Описание
---|---|---
`Length` | `int32` | Длина передаваемого пакета в байтах; или, если число отрицательное - код ошибки
`Data` | |  Данные, отправляемые в ответ на команду (если `Length` не отрицательно число)

В случае успешного выполнения команды сервером не требующего передачи дополнительных данных (см. состав и структура поля Data для каждой из команд) возвращается структура [OK_RESPONSE](#OK_RESPONSE), в котором поле `Data` нулевой длины.

В случае получения некорректного запроса сервер в ответ на запрос отправляет пакет длиной 4 байта,
содержащий [код ошибки](#перечень-кодов-ошибок-формируемых-сервером)
(отрицательное число типа `int32`).

## Перечень команд, обрабатываемых сервером

Ниже приведен список всех команд, обрабатываемых сервером:

Команда | Описание
---|---
_ | **Работа со средством измерения**
[VLST](#VLST) | Запрос списка ID измерительных средств, по которым возможна выгрузка данных
[VSET](#VSET) | Установить текущий ID измерительного средства
[VGET](#VGET) | Получить текущий ID измерительного средства
_ | **Работа со сессиями**
[SLST](#SLST) | Запрос списка доступных идентификаторов сессий для ранее выбранного измерительного средства
[SSET](#SSET) | Установить текущий идентификатор измерительной сессии
_ | **Работа с диапазонами данных**
[SGET](#SGET) | Получить текущий идентификатор измерительной сессии
[SFND](#SFND) | Получить идентификатор измерительной сессии по составному индексу
~~[SNXT](#SNXT)~~ | Получить идентификатор следующей измерительной сессии относительно текущей по составному индексу
~~[SPRV](#SPRV)~~ | Получить идентификатор предыдущей измерительной сессии относительно текущей по составному индексу
[SBEG](#SBEG) | Получить первый (начальный) идентификатор кадра [составной индекс](#sindex) для текущей измерительной сессии
[SEND](#SEND) | Получить последний (конечный) идентификатор кадра [составной индекс](#sindex) для текущей измерительной сессии
_ | **Работа с описанием видео каналов**
[NVID](#NVID) | Получить количество каналов видеоданных
[GVID](#GVID) | Получить конфигурацию канала видеоданных для текущей измерительной сессии
_ | **Работа с видео данными**
[FMRK](#FMRK) | Получить  идентификатор [составной индекс](#sindex) кадра, на который приходится запрашиваемый составной индекс.
[GFRM](#GFRM) | Получить кадр данных и его индекс, на который приходится запрашиваемый [составной индекс](#sindex)
[NFRM](#NFRM) | Получить следующий кадр и его индекс, относительно того, на который приходится запрашиваемый [составной индекс](#sindex) кадра
[PFRM](#PFRM) | Получить предыдущий кадр и его индекс, относительно того, на который приходится запрашиваемый [составной индекс](#sindex) кадра
_ | **Работа с ошибками**
[GLEM](#GLEM) | Получить строковое описание последней возникшей ошибки
_ | **Работа с данными путейской координаты**
[GCRD](#GCRD) | Получить информацию о километровой привязке

### Подробное описание команд

#### Работа со средством измерения

##### VLST

Запрос списка ID измерительных средств, по которым возможна выгрузка данных.

**Запрос:** 
Поле не используется

**Ответ:**
Поле содержит список  идентификаторов измерительных средств.
Каждый ID записан в виде  завершающейся нулем строки.

##### VSET

Установить текущий ID измерительного средства.
Сбрасывает ранее установленное значение командой [VSET](#VSET).

**Запрос:**
Поле содержит идентификатор измерительного средства,
записанный в виде завершающейся нулем строки.

**Ответ:**
Если команда выполнена успешно - [OK_RESPONSE](#OK_RESPONSE)

##### VGET

Получить текущий ID измерительного средства.
Предварительно должна быть вызвана команда [VSET](#VSET).

**Запрос:**
Поле не используется

**Ответ:**
Поле содержит  идентификатор измерительного средства,
записанный в виде завершающейся нулем строки.

**Ошибки:**
Если идентификатор ранее не был установлен командой [VSET](#VSET) - [VSET_REQUIRED]

#### Работа со сессиями

##### SLST

Запрос списка доступных идентификаторов сессий для ранее
выбранного командой [VSET](#VSET) измерительного средства.
Предварительно должна быть вызвана команда [VSET](#VSET).

**Запрос:**
Поле не используется

**Ответ:**
Поле содержит список идентификаторов измерительных сессий
для текущего измерительного средства.
Каждый ID записан в виде завершающейся нулем строки.

##### SSET

Установить текущий идентификатор измерительной сессии,
для которого в дальнейшем возможен запрос данных.
Предварительно должна быть вызвана команда [VSET](#VSET).

**Запрос:**
Поле содержит идентификатор измерительной сессии,
записанный в виде завершающейся нулем строки.

**Ответ:**
Если команда выполнена успешно - [OK_RESPONSE](#OK_RESPONSE)

#### Работа с диапазонами данных

##### SGET

Получить текущий идентификатор измерительной сессии.
Предварительно должны быть вызваны команды [VSET](#VSET), [SSET](#SSET).

**Запрос:**
Поле не используется

**Ответ:**
Поле содержит идентификатор измерительной сессии,
записанный в виде завершающейся нулем строки.

**Ошибки:**
Если идентификатор ранее не был установлен командой [VSET](#VSET) – [VSET_REQUIRED].
Если сессия ранее не была установлен командой [SSET](#SSET) – [SSET_REQUIRED].

##### SFND

Получить идентификатор измерительной сессии по составному индексу.
Предварительно должна быть вызвана команда [VSET](#VSET).

**Запрос:**
Поле содержит структуру [SIndex].

**Ответ:**
Поле содержит идентификатор измерительной сессии,
записанный в виде завершающейся нулем строки.

##### SNXT

Получить идентификатор следующей измерительной сессии
относительно текущей по составному индексу.
Предварительно должна быть вызвана команда [VSET](#VSET).

**Запрос:**
Поле содержит структуру [SIndex].

**Ответ:**
Поле содержит идентификатор измерительной сессии,
записанный в виде завершающейся нулем строки.

##### SPRV

Получить идентификатор предыдущей измерительной сессии
относительно текущей по составному индексу.
Предварительно должна быть вызвана команда [VSET](#VSET).

**Запрос:**
Поле содержит структуру [SIndex].

**Ответ:**
Поле содержит идентификатор измерительной сессии,
записанный в виде завершающейся нулем строки.

##### SBEG

Получить первый (начальный) идентификатор кадра [составной индекс](#sindex)
для текущей измерительной сессии.
Предварительно должны быть вызваны команды [VSET](#VSET), [SSET](#SSET).

**Запрос:**
Поле не используется.

**Ответ:**
Поле содержит структуру [SIndex].

##### SEND

Получить последний (конечный) идентификатор кадра [составной индекс](#sindex)
для текущей измерительной сессии.
Предварительно должны быть вызваны команды [VSET](#VSET), [SSET](#SSET).

**Запрос:**
Поле не используется

**Ответ:**
Поле содержит структуру [SIndex]

#### Работа с описанием видео каналов

##### NVID

Получить количество каналов видеоданных.
Предварительно должны быть вызваны команды [VSET](#VSET), [SSET](#SSET).

**Запрос:**
Поле не используется.

**Ответ:**
Поле содержит структуру [NChannel],
содержащее в поле num общее количество каналов данных.

##### GVID

Получить конфигурацию канала видеоданных для текущей измерительной сессии.
Предварительно должны быть вызваны команды [VSET](#VSET), [SSET](#SSET).

**Запрос:**
Поле содержит структуру [NChannel], содержащее в поле num индекс канала видеоданных.
Поле может принимать значения от 0 до [NChannel].num-1,
полученное в ответ на команду [NVID](#NVID)

**Ответ:**
Поле содержит структуру [SChannelInfo].

#### Работа с видео данными

##### FMRK

Получить  идентификатор [составной индекс](#sindex)  кадра,
на который приходится запрашиваемый составной индекс.
Предварительно должны быть вызваны команды [VSET](#VSET).
Последовательно вызывает [SFND](#SFND), [SSET](#SSET).

**Запрос:**
Поле содержит структуру [SChannelIndex]

**Ответ:**
Поле содержит структуру [SIndex].

**Ошибки:**
Если идентификатор ранее не был установлен командой [VSET](#VSET) – [VSET_REQUIRED].

##### GFRM

Получить кадр данных, на который приходится запрашиваемый составной индекс.
Дополнительно возвращается идентификатор [составной индекс](#sindex) кадра.
Предварительно должны быть вызваны команды [VSET](#VSET).
Последовательно вызывает [SFND](#SFND), [SSET](#SSET).

**Запрос:**
Поле содержит структуру [SChannelIndex]

**Ответ:**
Поле содержит структуру [SIndexFrame].

**Ошибки:**
Если идентификатор ранее не был установлен командой [VSET](#VSET) – [VSET_REQUIRED].

##### NFRM

Получить следующий, относительно того, на который приходится запрашиваемый
составной индекс, кадр данных.
Дополнительно возвращается идентификатор [составной индекс](#sindex)  кадра.
Предварительно должны быть вызваны команды [VSET](#VSET).
Последовательно вызывает [SFND](#SFND), [SSET](#SSET).

**Запрос:**
Поле содержит структуру [SChannelIndex]

**Ответ:**
Поле содержит структуру [SIndexFrame].

**Ошибки:**
Если идентификатор ранее не был установлен командой [VSET](#VSET) – [VSET_REQUIRED].

##### PFRM

Получить предыдущий, относительно того, на который приходится запрашиваемый
составной индекс, кадр данных.
Дополнительно возвращается идентификатор [составной индекс](#sindex)  кадра.
Предварительно должны быть вызваны команды [VSET](#VSET).
Последовательно вызывает [SFND](#SFND), [SSET](#SSET).

**Запрос:**
Поле содержит структуру [SChannelIndex]

**Ответ:**
Поле содержит структуру [SIndexFrame].

**Ошибки:**
Если идентификатор ранее не был установлен командой [VSET](#VSET) – [VSET_REQUIRED].

##### FGET

#### Работа с ошибками

##### GLEM

Получить строковое описание последней возникшей ошибки.

**Запрос:**
Поле не используется.

**Ответ:**
Поле содержит завершающуюся нулем строку с описанием последней возникшей ошибки.

#### Работа с данными путейской координаты

##### GCRD

Получить информацию о километровой привязке.
Предварительно должна быть вызвана команда [VSET](#VSET).
Последовательно вызывает [SFND](#SFND), [SSET](#SSET).

**Запрос:**
Поле содержит структуру [SIndex]

**Ответ:**
Поле содержит структуру [SCoord].

**Ошибки:**
Если идентификатор ранее не был установлен командой [VSET](#VSET) – [VSET_REQUIRED].

### Формат данных запроса и ответа

#### OK_RESPONSE

В случае успешного выполнения команды сервером не требующего передачи дополнительных данных
(см. состав и структура поля `Data` для каждой из команд)
возвращается структура [OK_RESPONSE](#OK_RESPONSE), в котором поле Data нулевой длины.

#### Используемые структуры данных

Примечание:

* Все строковые параметры записаны в кодировке `UTF-8`.
* Порядок записи данных: `little-endian`.
* Выравнивание данных в структурах не используется (равно 1).

##### NChannel

``` c++
    struct NChannel
    {
        uint8 num;           ///< количество или индекс канала данных
    };
```

##### SChannelId

``` c++
    struct SChannelId
    {
        uint8 id;            ///< идентификатор (номер) канала данных
    };
```

##### SChannelInfo

Описание видео канала

``` c++
    struct SChannelInfo:
        SChannelId
    {
        uint16 line_count;   ///< кол-во линий в одном кадре (высота кадра данных)
        uint16 points_count; ///< кол-во точек в одном кадре (ширина кадра данных)
        float  len_line;     ///< Ширина линии, мм
        float  len_point;    ///< Ширина точки, мм
        uint8  rail;         ///< положение камеры над рельсом: 0 – левый; 1 – правый
        uint8  inner;        ///< положение камеры: 0 – внешняя часть рельса; 1 -внутренняя
        int16  cam_offset;   ///< сдвижка центра камеры в сторону котла относительно некотлового шкворня (мм)
    };
```

##### SIndex

Составной индекс

``` c++
    const uint32 INDEX_FACTOR = 1e6;    ///< коэф. формирования составного индекса

    struct SIndex
    {
        uint64  value;       ///< составной индекс

        /// получение целой части индекса
        uint32 s()  const
        {
            return value / INDEX_FACTOR;
        }

        /// получение дробной части индекса
        uint32 l()  const
        {
            return value % INDEX_FACTOR;
        }
    };
```

##### SChannelIndex

``` c++
    struct SChannelIndex:
        SChannelId,
        SIndex
    {
    };
```

##### SFrame

Данные видео кадра

``` c++
    struct SFrame
    {
        uint32 size;            ///< размер кадра данных (байты)
        uint8  frame[];        ///< кадр данных JPEG-фрейм
    };
```

##### SIndexFrame

составной индекс и данные кадра

``` c++
    struct SIndexFrame:
        SIndex,
        SFrame
    {
    };
```

##### SCoord

данные путейской координаты

``` c++
    struct SCoord
    {
        int32  track_id;     ///< идентификатор трека
        double track_offset; ///< смещение относительно начала трека
        uint32 line;         ///< код направления
        uint8  park;         ///< код парка (0 – если путь не парковый)
        uint8  way[20];      ///< номер пути (UTF-8 строка)
        int16  km;           ///< номер километра
        double m;            ///< метр
        double lat           ///< широта
        double lon;          ///< долгота
        double dc;           ///< относительная координата в метрах от начала сессии
    };
```

#### Перечень кодов ошибок, формируемых сервером

Сообщения об ошибке, формируемые сервером представляют собой 4-х байтные слова (int32), содержащие отрицательный код ошибки.

Значение | Код | Наименование | Описание
---|---|---|---
-1 | `UNKNOWN_COMMAND`  | Неизвестная команда  | В запросе передан неизвестный серверу код команды
-4 | `VSET_REQUIRED` | Не был установлен текущий ID измерительного средства  | Выполнена команда, для которой ранее  должна была быть   выполнена [VSET](#VSET)
-5 | `SSET_REQUIRED` | Не был установлен текущий ID измерительной сессии  | Выполнена команда, для которой ранее должна была быть  выполнена [SSET](#SSET)
-6 | `DATA_NOT_FOUND` | Данные не найдены  | Данные для ответа не  найдены
-7 | `WRONG_REQUEST` | Неверный запрос данных   | Переданы данные, которые не могут быть использованы в данном запросе или неверная структура сообщения запроса
-10 | `INTERNAL` | Внутренняя ошибка сервера | Произошла внутренняя ошибка сервера

[UNKNOWN_COMMAND]: #перечень-кодов-ошибок-формируемых-сервером
[WRONG_COMMAND]: #перечень-кодов-ошибок-формируемых-сервером
[WRONG_REQUEST]: #перечень-кодов-ошибок-формируемых-сервером
[VSET_REQUIRED]: #перечень-кодов-ошибок-формируемых-сервером
[SSET_REQUIRED]: #перечень-кодов-ошибок-формируемых-сервером
[DATA_NOT_FOUND]: #перечень-кодов-ошибок-формируемых-сервером
[INTERNAL]: #перечень-кодов-ошибок-формируемых-сервером

## Пример использования

Пример с использованием [SSET](#SSET)

1. Вызвать [VSET](#VSET) и выбрать текущее измерительное средство.
2. Вызвать [SFND](#SFND), для указанного составного индекса получить идентификатор измерительной сессии.
3. Вызвать [SSET](#SSET) и выбрать текущую измерительную сессию, полученную в п. 2.
4. Вызвать [NVID](#NVID)/[GVID](#GVID) для получения конфигурации каналов видеоданных
5. При необходимости вызвать [SBEG](#SBEG), [SEND](#SEND) для определения граничных составных индексов.
6. Вызвать [GFRM](#GFRM), для указанного составного индекса кадра и канала видеоданных получить JPEG-фрейм.
7. При необходимости последовательно вызывать [NFRM](#NFRM) или [PFRM](#PFRM) для получения следующего/предыдущего JPEG-фрейма.
